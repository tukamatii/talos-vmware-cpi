---
- name: Wait for vsphere-cloud-controller-manager DaemonSet to be fully rolled out
  kubernetes.core.k8s_info:
    api_version: apps/v1
    kind: DaemonSet
    name: vsphere-cloud-controller-manager
    namespace: kube-system
    kubeconfig: "{{kube_config_file}}"
  register: cpi_ds
  until: >
    cpi_ds.resources | length > 0 and
    cpi_ds.resources[0].status is defined and
    cpi_ds.resources[0].status.desiredNumberScheduled is defined and
    cpi_ds.resources[0].status.numberReady is defined and
    cpi_ds.resources[0].status.updatedNumberScheduled is defined and
    cpi_ds.resources[0].status.numberReady == cpi_ds.resources[0].status.desiredNumberScheduled and
    cpi_ds.resources[0].status.updatedNumberScheduled == cpi_ds.resources[0].status.desiredNumberScheduled
  retries: 60
  delay: 10
  delegate_to: localhost

- name: Fetch all nodes to check providerID
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Node
    kubeconfig: "{{ kube_config_file }}"
  register: nodes
  delegate_to: localhost
  run_once: true

- name: Check if all nodes have a vsphere providerID
  ansible.builtin.set_fact:
    all_nodes_have_vsphere_provider: "{{ 
      nodes.resources is defined and
      nodes.resources | length > 0 and
      (nodes.resources | selectattr('spec.providerID', 'defined') | 
       selectattr('spec.providerID', 'match', '^vsphere://') | list | length) == (nodes.resources | length)
    }}"

- name: Wait 5 more minutes
  ansible.builtin.pause:
    minutes: 5
  when: talos_bootstrap.changed

- name: Restart kubelet on VIP node (only if some node lacks vsphere providerID)
  ansible.builtin.shell:
    cmd: "talosctl service kubelet restart -n {{ talos_interface_vip }} --talosconfig {{ talos_config_folder }}{{ target }}.yaml"
  delegate_to: localhost
  run_once: true
  async: 120
  poll: 0
  when: not all_nodes_have_vsphere_provider

- name: Wait one minute after kubelet restart
  ansible.builtin.pause:
    minutes: 1
  when: not all_nodes_have_vsphere_provider

- name: Wait for all nodes to have cloud provider initialized (no uninitialized taint)
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Node
    kubeconfig: "{{kube_config_file}}"
  register: nodes
  until: >
    nodes.resources is defined and
    nodes.resources | length > 0 and
    (nodes.resources | json_query('[?spec.taints[?key == `node.cloudprovider.kubernetes.io/uninitialized`]]') | length) == 0
  retries: 120
  delay: 5
  delegate_to: localhost
